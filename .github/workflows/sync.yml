name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # every day
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # Step 1: run a standard checkout action
      - name: Checkout target repo
        uses: actions/checkout@v3

      # Step 2: run the sync action
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: cmliu/edgetunnel
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # automatically generated, no need to set

          # Set test_mode true to run tests instead of the true action!!
          test_mode: false
      # ... (上面是你之前的 Modify files 步骤) ...

      # =========================================================
      # ✨ 新增步骤：主动通知 Cloudflare 立即部署
      # =========================================================
      - name: Trigger Cloudflare Build
        # 只有当确实有更新，或者我们修改了文件时，才触发
        if: steps.sync.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "正在通知 Cloudflare 进行构建..."
          
          # 使用 curl 发送 POST 请求给你的 Hook URL
          # 这里的 secrets.CF_DEPLOY_HOOK 就是你在 GitHub 设置里填的那个链接
          curl -X POST "${{ secrets.CF_DEPLOY_HOOK }}"
          
          echo "通知发送成功！Cloudflare 应该已经开始构建了。"
      - name: Sync check
        if: failure()
        run: |
          echo "[Error] 由于上游仓库的 workflow 文件变更，导致 GitHub 自动暂停了本次自动更新，你需要手动 Sync Fork 一次，详细教程请查看项目README.md "
          echo "[Error] Due to a change in the workflow file of the upstream repository, GitHub has automatically suspended the scheduled automatic update. You need to manually sync your fork. Please refer to the project README.md for instructions. "
          exit 1
